# 要求内容

## 概要

特定の条件を満たすGmail（メルマガ）を自動で取得し、内容をMarkdown形式に変換してGoogleドライブの指定フォルダにアップロードする。実行後、Discordに通知を行う。

## 背景

毎日配信される複数の英語学習メルマガやニュースレターをGoogleドライブ上で一元管理し、後から検索や閲覧をしやすくするため。手動での保存作業を自動化し、漏れをなくす。

## 実装対象の機能

### 1. Gmail取得・変換・アップロード機能

- 指定した条件（送信元、件名パターンなど）に一致する未処理のメールをGmail API経由で取得する。
- メールのHTML/テキスト内容をMarkdown形式に変換する。
- 変換したMarkdownファイルを、メールの種類ごとに指定されたGoogleドライブのフォルダにアップロードする。
- 二重取り込みを防止するため、処理済みメールを適切に管理する（ラベル付与や既読化など）。

### 2. マルチターゲット対応（YAML設定）

- 複数のメルマガ設定をYAMLファイルで管理できる。
- 各ターゲットごとに、検索条件、保存先フォルダID、配信スケジュール（実行タイミングのフィルタリング）を定義する。

### 3. Discord通知機能

- 処理が完了した際に、成否に関わらず指定されたWebhook URLを通じてDiscordに通知を送信する。
- **失敗時には、エラーメッセージや発生した例外の種類など、原因特定に必要な情報を含めること。**

### 4. インフラ構築（Terraform）

- Google Cloud Functions 上でスクリプトが動作するように構築する。
- Cloud Scheduler を利用して定期実行（例：1時間おき）を設定する。
- 認証情報やWebhook URLなどの機密情報は Secret Manager で管理する。

## 受け入れ条件

### 機能動作

- [ ] HAPA英会話、ニックのひとこと英会話、週刊Life is beautiful の各メールが正しくMarkdown変換され、指定のフォルダに保存されること。
- [ ] ファイル名の冒頭に `yyyymmdd` 形式の配信日が含まれ（例：`20260228_HAPA英会話.md`）、内容が正しくMarkdownとしてレンダリング可能なこと。
- [ ] 処理完了後にDiscordに通知が届くこと。
    - 成功時：処理件数、対象のメルマガ名、ファイル名など。
    - 失敗時：エラー概要、エラーが発生したステップ、原因（例外メッセージ）など。
- [ ] 既に処理済みのメールが再度アップロードされないこと。

### 運用・セキュリティ

- [ ] 認証情報（GCP Service Account, Discord Webhook）がソースコードにハードコードされていないこと。
- [ ] `terraform apply` によって、Cloud Functions や Scheduler 等の環境が一括で構築できること。
- [ ] `uv` を使用して依存関係が管理されており、ローカル環境でもテスト実行が可能なこと。
- [ ] **運用コストが Google Cloud の無料枠（Free Tier）内に収まる、あるいは極めて低コスト（月額数百円以内）であること。**

## 成功指標

- メルマガ配信から1時間以内にGoogleドライブへのアップロードが完了していること。
- 手動介入なしで1週間以上安定稼働すること。

## スコープ外

- 過去の全メールの一括取り込み（直近数日分のみを対象とする）。
- Googleドライブ上でのファイル編集機能。
- メルマガ以外の一般的なメールの処理。

## 参照ドキュメント

- `docs/ideas/20260228-upload-gmails-to-gdrive/initial-requirements.md`
- `docs/setup/gcp-manual-setup.md` - Google Cloud 手動セットアップガイド (フェーズ 0)
